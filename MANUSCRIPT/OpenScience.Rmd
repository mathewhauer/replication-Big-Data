---
title: "R Code for: Identifying Demographic Anomalies in Big (and Small) Data"
author: ""
#date: "3/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Replication document

```{r Load, include=FALSE}
library(knitr)
read_chunk('../R/SCRIPTS/000-Libraries.R')
read_chunk('../R/SCRIPTS/001-DataLoad.R')
read_chunk('../R/SCRIPTS/001-AnomaliesDetection.R')
read_chunk('../R/SCRIPTS/002-StatesAnalysis.R')
read_chunk('../R/SCRIPTS/003-SummaryStats.R')
read_chunk('../R/SCRIPTS/004-SimulationPower.R')
```

# Loading the libraries and setting the workspace
```{r libraries, warning=FALSE, message = FALSE}
```

# Anomaly Detection
This code chunk will loop through monthly, state-level mortality and fertility data to locate anomalies and save the results to the hard drive. This loop is set to just 5 states to aid in computational speed.

```{r AnomaliesDetection, warning = FALSE, message=FALSE, cache=TRUE}
```

# Reloading data
This chunk simply reloads to the data that was saved to the hard drive.
```{r DataLoad, warning=FALSE, message = FALSE}
```

# Summary Statistics
This chunk will calculate several summary statistics used throughout the manuscript.
```{r SumStats, warning=FALSE, message = FALSE}
```

# Abstract Calculations
This will calculate the computations found in the Abstract.
```{r, warning = FALSE, message=FALSE}
## These calculations are for the abstract.
anom_mort <- read_rds("../R/DATA-PROCESSED/mortality_anomalies") %>%
   na.omit %>%
   mutate(component = "Mortality")

 anom_fert <- read_rds("../R/DATA-PROCESSED/fertility_anomalies") %>%
   na.omit %>%
   mutate(component = "Fertility")
 
abstract <- rbind(anom_mort, anom_fert) %>%
   group_by(type, location, component) %>%
   dplyr::summarise(Anomalies =  n()) %>%
  ungroup() %>%
  dplyr::select(location, component) %>%
  group_by(component)

nrow(distinct(abstract[which(abstract$component=="Mortality"),]))
nrow(distinct(abstract[which(abstract$component=="Fertility"),]))


abstractsums <- rbind(mortsum, fertsum)

# Total # of states with mortality anomalies greater than 0
nrow(abstractsums[which(abstractsums$component == "Mortality" & abstractsums$ydiff>0),])
# Sums of Mortality anomalies greater than 0 
sum(abstractsums$ydiff[which(abstractsums$component == "Mortality" & abstractsums$ydiff>0)])
# Total # of states with mortality anomalies less than 0
nrow(abstractsums[which(abstractsums$component == "Mortality" & abstractsums$ydiff<0),])
# Sums of Mortality anomalies less than 0 
sum(abstractsums$ydiff[which(abstractsums$component == "Mortality" & abstractsums$ydiff<0)])

# Total # of states with mortality anomalies greater than 0
nrow(abstractsums[which(abstractsums$component == "Fertility" & abstractsums$ydiff>0),])
# Total # of states with 
sum(abstractsums$ydiff[which(abstractsums$component == "Fertility" & abstractsums$ydiff>0)])
nrow(abstractsums[which(abstractsums$component == "Fertility" & abstractsums$ydiff<0),])
sum(abstractsums$ydiff[which(abstractsums$component == "Fertility" & abstractsums$ydiff<0)])
```

# Simulation
This is the simulation exercise.
```{r SimulationPower, cache=TRUE, message=FALSE, warning=FALSE}
```

# Figures and Tables
Helper function for the figures.

```{r , message=FALSE, warning=FALSE}
n.sims <- 1e3

# This function will simulate 100 time series with similar values as the target database and make a ggplot figure version of tsoutliers baseplot but with an 95th percentile confidence interval.
makefigure <- function(this.outlier, titles){
set.seed(1)
sims.hist <- matrix(NA,nrow=n.sims,ncol=length(this.outlier$y))

   createsim <- function(ii){
    
    arima.sim(n=length(this.outlier$y), model=list(this.outlier$fit), sd = sdval) + as.vector(this.outlier$yadj)
   }
     sdval <- sqrt(this.outlier$fit$sigma2)
  for ( ii in 1:n.sims ) {
    sims.hist[ii,] <- as.vector(createsim())
  }


conf <- c(0.95)
ylim <- range(
  apply(sims.hist,2,quantile,prob=c((1-max(conf))/2,1-(1-max(conf))/2)))
boundaries.hist <- apply(sims.hist,2,quantile,prob=c((1-rev(conf)[1])/2,1-(1-rev(conf)[1])/2))

a <- data.frame(Y=as.matrix(this.outlier$yadj),
                date = time(this.outlier$yadj),
                ymin = as.matrix(boundaries.hist[1,]),
                ymax = as.matrix(boundaries.hist[2,])
)
b <- data.frame(y = as.matrix(this.outlier$y),
                date = time(this.outlier$y))
pts <- data.frame(date = this.outlier$times,
                  y = this.outlier$y[this.outlier$outliers$ind])

effectsizes <- data.frame(date =time(this.outlier$y),
                           y= this.outlier$y - this.outlier$yadj)

top <- ggplot(data= a, aes(x = date, y=Y)) +
  geom_line(data= b, aes(x=date, y=y), color = "red") +
  geom_line() +
  geom_ribbon(aes(ymin = ymin, ymax = ymax), alpha = 0.2) +
  geom_point(data=pts, aes(x=date, y =y), color = "red", fill = NA, size = 2, shape =21) +
  theme_bw() +
  scale_y_continuous(labels=comma) +
  labs(x="", y ="",
       title = paste(titles, "<br>
       <span style='font-size:10pt'><span style='color:#FF0000'>**Original**</span> and **Adjusted**  series</span>"
        )) +
  theme(
    plot.title = element_markdown(lineheight = 1.2),
    axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x = element_blank(),
    plot.margin = unit(c(0.1, 0, 0, 0), "cm")
  )

bot <- 
  ggplot(data = effectsizes, aes(x=date, y=y)) +
  geom_line(color="blue") +
  theme_bw() +
  theme(plot.margin = unit(c(0, 0, 0, 0), "cm")) +
  scale_y_continuous(labels=comma,
                     position = "right") +
  labs(x="", y ="")

together <- plot_grid(top, bot, ncol=1,
           align = "v", rel_heights = c(1,0.6))

return(together)
}

```

## Figure 1
```{r FertilityAnomalies, message = FALSE, warning = FALSE, fig.cap= paste("\\textbf{Anomaly detection in Louisiana (a) and Connecticut (b) state fertility, 2003-2018.} The top part of each panel contains the original time series (light gray), the corrected, counter-factual time series in the absence of anomalies (blue), and the red dots correspond to the onset of detected anomalies. The bottom part of each panel contains the magnitude and type of the outlier in red. In (a), we detect two outliers, back-to-back, likely resulting from Hurricane Katrina in August and October 2005, representing a decrease of more than 4,400 births due to the hurricane (t-statistics= -6.002 and -4.997). In (b), we detect one outlier, a level shift outlier (LS) in August 2009. We believe this reduction is attributable to the stock market crash 11 months earlier (t-statistic = -3.71). \\label{fig:fertla}")}

a<- makefigure(outlier.fert.la, "Louisiana - Fertility")
b <- makefigure(outlier.fert.conn, "Connecticut - Fertility")

together <- plot_grid(a,
               b, 
               ncol=1,
               labels= "auto",
               rel_heights = c(1, 1))
ggdraw(add_sub(together, "Shaded region is the 95th percentile confidence interval", size = 8 ,x=1, hjust=1.1))
```

## Figure 2
```{r MortalityAnomalies, message = FALSE, warning = FALSE, fig.height = 5, fig.cap= paste("\\textbf{Anomaly Detection for New York (a) and New Hampshire (b) state mortality, 1999-2016.} In New York (a), we detect additive outliers (AO) in January 2000, September 2001, January 2005, and January 2013; temporary change (TC) outliers in February 2007 and January 2015; and a level shift (LS) starting in February 2004. In New Hampshire (b), we detect two outliers, both level shift outliers (LS) in April 2010 and again in November 2014. These anomalies suggest New York experienced a significant mortality event in September 2001 and New Hampshire experienced approximately 9,700 more deaths than expected since 2010 or 14% more deaths in the state over just seven years. \\label{fig:mortnewhamp}")}

a<- makefigure(outlier.mort.ny, "New York - Mortality")
b <- makefigure(outlier.mort.nh, "New Hampshire - Mortality")

together <- plot_grid(a,
               b, 
               ncol=1,
               labels= "auto",
               rel_heights = c(1, 1))
ggdraw(add_sub(together, "Shaded region is the 95th percentile confidence interval", size = 8 ,x=1, hjust=1.1))
```

## Figure 3
```{r TrueAnomalies, message = FALSE, warning = FALSE, fig.height = 5, fig.cap= paste("\\textbf{Anomaly detection in Hawaii state fertility (a) and Ohio state mortality (b).} Here we detect one outlier, an additive outlier (AO) in May 2014 in Hawaii (a), representing a large, unexplainable 14% increase in expected births in that month. We also detect a strong level shift (LS) reduction (b), representing a large, unexplainable reduction of nearly 40,000 deaths in Ohio.  \\label{fig:ferthawaii}")}

a<- makefigure(outlier.fert.hi, "Hawaii - Fertility")
b <- makefigure(outlier.mort.oh, "Ohio - Mortality")

together <- plot_grid(a,
               b, 
               ncol=1,
               labels= "auto",
               rel_heights = c(1, 1))
ggdraw(add_sub(together, "Shaded region is the 95th percentile confidence interval", size = 8 ,x=1, hjust=1.1))
```

## Table 1
```{r, echo = TRUE}

sums2 <- sums %>%
  dplyr::select(percent_anom = `\\% of Total`, everything())
kable(sums,
       "html",
       # booktabs = T,
       format.args = list(big.mark = ","),
       escape = FALSE) %>%
   kable_styling(position = "center")

```

## Figure 3
```{r AnomalyMap, warning=FALSE, message=FALSE}
 data(state_laea)

 anom_mort2 <- rbind(anom_mort, anom_fert) %>%
   group_by(type, location, component) %>%
   dplyr::summarise(Anomalies =  n()) %>%
   mutate(ident = paste0(component, " - ", type),
          GEOID = substr(location, 2,3)) %>%
   ungroup() %>%
   dplyr::select(GEOID, Anomalies, ident) %>%
   spread(ident, Anomalies)
 
  anom_mort2[is.na(anom_mort2)] <- 0



 states <- left_join(state_laea, anom_mort2) %>%
   gather(ident, Anomalies, `Fertility - AO`:`Mortality - TC`) 
 states[is.na(states)] <- 0
 states <- states %>%
   mutate(Anomalies = factor(Anomalies))

 states$ident2 <- factor(
   states$ident,
   levels = c("Mortality - AO", "Fertility - AO",
              "Mortality - TC", "Fertility - TC",
              "Mortality - LS", "Fertility - LS")
 )

 colorpal <- c("#ffffff", "#ffffcc", "#a1dab4", "#41b6c4", "#2c7fb8", "#253494")

   ggplot(data=states) +
   geom_sf(aes(fill = Anomalies),  lwd = 1/2) +
   theme_bw() +
   theme(axis.title=element_blank(),
         axis.text=element_blank(),
         axis.ticks=element_blank(),
         legend.position="bottom"
   )+
   guides(fill=guide_legend(nrow=1,byrow=TRUE)) +
   facet_wrap(~ident2, ncol=2) +
     scale_fill_manual(name = "# of Anomalies", values = colorpal) +

   NULL
```
